<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:LehrplanGenerator.ViewModels.StudyPlan"
             x:Class="LehrplanGenerator.Views.StudyPlan.StudyPlanView"
             x:DataType="vm:StudyPlanViewModel">

<Grid>
  <!-- Loading State -->
  <StackPanel IsVisible="{Binding IsLoading}" 
              HorizontalAlignment="Center" 
              VerticalAlignment="Center" 
              Spacing="10">
    <TextBlock Text="Lernplan wird geladen..." FontSize="18" HorizontalAlignment="Center"/>
    <ProgressBar IsIndeterminate="True" Width="300"/>
  </StackPanel>

  <!-- Error State -->
  <StackPanel IsVisible="{Binding ErrorMessage, Converter={x:Static ObjectConverters.IsNotNull}}" 
              HorizontalAlignment="Center" 
              VerticalAlignment="Center" 
              Spacing="10"
              Margin="20">
    <TextBlock Text="Fehler" FontSize="20" FontWeight="Bold" HorizontalAlignment="Center"/>
    <TextBlock Text="{Binding ErrorMessage}" 
               TextWrapping="Wrap" 
               HorizontalAlignment="Center"
               MaxWidth="400"/>
    <Button Content="Erneut versuchen" 
            Command="{Binding RefreshCommand}"
            HorizontalAlignment="Center"/>
  </StackPanel>

  <!-- Content State -->
  <ScrollViewer VerticalScrollBarVisibility="Auto" 
                IsVisible="{Binding !IsLoading}">
    <StackPanel Margin="20" Spacing="10">

      <!-- Header mit Refresh-Button -->
      <Grid Margin="0,0,0,15">
        <TextBlock Text="{Binding Topic}" 
                   FontSize="24" 
                   FontWeight="Bold" 
                   HorizontalAlignment="Left"/>
        <Button Content="ðŸ”„ Aktualisieren" 
                Command="{Binding RefreshCommand}"
                HorizontalAlignment="Right"/>
      </Grid>

      <!-- Debug Info -->
      <TextBlock Text="{Binding Days.Count, StringFormat='Anzahl Tage: {0}'}" 
                 FontSize="12" 
                 Foreground="Gray"/>

      <!-- Days List -->
      <ItemsControl ItemsSource="{Binding Days}">
        <ItemsControl.ItemTemplate>
          <DataTemplate x:DataType="vm:DayPlanViewModel">
            <Expander Header="{Binding DisplayDate}" Margin="0,0,0,5">
              <ItemsControl ItemsSource="{Binding Tasks}">
                <ItemsControl.ItemTemplate>
                  <DataTemplate x:DataType="vm:TaskItemViewModel">
                    <Border Margin="0,0,0,5" Padding="5" BorderThickness="1" BorderBrush="Gray" CornerRadius="4">
                      <StackPanel>
                        <TextBlock Text="{Binding Title}" FontWeight="Bold"/>

                        <TextBlock FontStyle="Italic">
                          <TextBlock.Text>
                          <MultiBinding StringFormat="{}{0} - {1}">
                            <Binding Path="StartTime"/>
                            <Binding Path="EndTime"/>
                          </MultiBinding>
                        </TextBlock.Text>
                        </TextBlock>
                      <TextBlock Text="{Binding Description}" TextWrapping="Wrap"/>
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </Expander>
        </DataTemplate>
      </ItemsControl.ItemTemplate>
    </ItemsControl>

      <!-- Empty State -->
      <TextBlock Text="Kein Lernplan vorhanden. Bitte nutzen Sie den Chat, um einen Plan zu erstellen." 
                 FontStyle="Italic"
                 HorizontalAlignment="Center"
                 Margin="20"
                 IsVisible="{Binding Days.Count, Converter={x:Static ObjectConverters.Equal}, ConverterParameter=0}"/>
    </StackPanel>
  </ScrollViewer>
</Grid>
</UserControl>